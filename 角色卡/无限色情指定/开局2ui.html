```html
<html>

<head>
  <style>
    /* 全局样式 - Windows扁平化风格 */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #1e1e1e;
      color: #e6e6e6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    h1,
    h2,
    h3 {
      color: #ffffff;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
    }

    /* Windows 风格按钮 */
    button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      font-weight: 400;
      transition: background-color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }

    button:hover {
      background-color: #106ebe;
    }

    button.active {
      background-color: #005a9e;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
    }

    button.random {
      background-color: #e81123;
    }

    button.random:hover {
      background-color: #c41019;
    }

    button.next-step {
      background-color: #107c10;
      font-size: 16px;
      padding: 12px 25px;
      margin: 20px auto;
      display: block;
      width: 200px;
    }

    button.next-step:disabled {
      background-color: #505050;
      cursor: not-allowed;
    }

    /* 阶段容器 */
    .stage {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      margin-bottom: 30px;
      background-color: #2d2d2d;
      padding: 20px;
      border: 1px solid #3e3e3e;
    }

    .stage.active {
      display: block;
      opacity: 1;
    }

    /* Windows 进度指示器 */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin: 0 auto 30px;
      max-width: 600px;
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 17px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #3e3e3e;
      z-index: 1;
    }

    .progress-step {
      width: 36px;
      height: 36px;
      background-color: #3e3e3e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      z-index: 2;
      position: relative;
    }

    .progress-step.active {
      background-color: #0078d7;
    }

    .progress-step.completed {
      background-color: #107c10;
    }

    /* 性别选择卡片 */
    .gender-selection {
      display: flex;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .gender-card {
      width: 220px;
      height: 280px;
      background-color: #3e3e3e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .gender-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .gender-card.selected {
      border: 2px solid #0078d7;
      box-shadow: 0 0 15px rgba(0, 120, 215, 0.5);
    }

    .gender-card .gender-icon {
      height: 70%;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5em;
      color: white;
    }

    .gender-card .gender-title {
      height: 30%;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: bold;
      background-color: #252525;
    }

    /* 选项卡样式 */
    .tab-container {
      margin-bottom: 20px;
    }

    .tabs {
      display: flex;
      background-color: #252525;
      border-bottom: 2px solid #0078d7;
      overflow-x: auto;
      white-space: nowrap;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tab:hover {
      background-color: #3e3e3e;
    }

    .tab.active {
      background-color: #0078d7;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px;
      background-color: #2d2d2d;
      border: 1px solid #3e3e3e;
      border-top: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 选项网格 */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background-color: #252525;
    }

    .option-item {
      padding: 12px;
      background-color: #3e3e3e;
      cursor: pointer;
      transition: background-color 0.2s;
      text-align: center;
      border-left: 3px solid transparent;
    }

    .option-item:hover {
      background-color: #505050;
    }

    .option-item.selected {
      background-color: #333333;
      border-left: 3px solid #0078d7;
    }

    .custom-controls {
      margin-top: 20px;
      padding: 15px;
      background-color: #333333;
      border: 1px solid #505050;
    }

    .custom-field {
      margin-bottom: 15px;
    }

    .custom-field label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .custom-field input,
    .custom-field textarea {
      width: 100%;
      padding: 12px;
      background-color: #252525;
      border: 1px solid #505050;
      color: white;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    .custom-field textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* 结果区域 */
    .result-container {
      margin-top: 30px;
      padding: 20px;
      background-color: #2d2d2d;
      border: 1px solid #3e3e3e;
    }

    .world-description,
    .story-preview {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #252525;
      border-left: 4px solid #0078d7;
      white-space: pre-line;
      line-height: 1.6;
    }

    .story-preview {
      border-left-color: #e81123;
      font-style: italic;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    /* 选择摘要 */
    .selection-summary {
      background-color: #252525;
      padding: 15px;
      margin-top: 20px;
      border: 1px solid #3e3e3e;
    }

    .selection-item {
      display: flex;
      margin: 8px 0;
    }

    .selection-label {
      font-weight: bold;
      color: #0078d7;
      width: 120px;
      flex-shrink: 0;
    }

    /* 加载动画 */
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 120, 215, 0.2);
      border-radius: 50%;
      border-top-color: #0078d7;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* 多选框样式 */
    .multi-select-container {
      max-height: 300px;
      overflow-y: auto;
      background-color: #252525;
      padding: 10px;
      margin-bottom: 20px;
    }

    .multi-select-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: #3e3e3e;
    }

    .multi-select-item input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      accent-color: #0078d7;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .gender-selection {
        gap: 15px;
      }

      .gender-card {
        width: 160px;
        height: 200px;
      }

      .options-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .progress-steps {
        max-width: 100%;
      }
    }

    /* 用户头像 */
    .user_avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      background-color: #0078d7;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <!-- disable-default-loading -->
  <div class="container">
    <h1>幻想世界创建器</h1>

    <!-- 进度指示器 -->
    <div class="progress-steps">
      <div class="progress-step active" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
      <div class="progress-step" id="step5">5</div>
    </div>

    <!-- 第一阶段：性别选择 -->
    <div class="stage active" id="stage1">
      <h2>选择你的性别</h2>
      <p style="text-align:center;">请选择你在幻想世界中的性别，这将决定可选的主角角色范围</p>

      <div class="gender-selection">
        <div class="gender-card" data-gender="male" onclick="selectGender('male')">
          <div class="gender-icon" style="background-color:#0078d7;">♂</div>
          <div class="gender-title">男性</div>
        </div>
        <div class="gender-card" data-gender="female" onclick="selectGender('female')">
          <div class="gender-icon" style="background-color:#e81123;">♀</div>
          <div class="gender-title">女性</div>
        </div>
      </div>

      <button class="next-step" id="next-to-stage2" disabled>下一步</button>
    </div>

    <!-- 第二阶段：主角角色选择 -->
    <div class="stage" id="stage2">
      <h2>选择你的主角角色</h2>
      <p style="text-align:center;" id="protagonist-desc">根据你的性别选择，你可以从以下角色中选择一个作为你的主角</p>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('protagonist-tab', 0)">角色列表</div>
          <div class="tab" onclick="switchTab('protagonist-tab', 1)">自定义角色</div>
        </div>

        <div class="tab-content active" id="protagonist-tab-0">
          <div class="options-grid" id="protagonists-grid">
            <!-- 角色选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectProtagonist()">随机选择</button>
        </div>

        <div class="tab-content" id="protagonist-tab-1">
          <div class="custom-controls">
            <div class="custom-field">
              <label for="custom-protagonist-name">角色名称</label>
              <input type="text" id="custom-protagonist-name" placeholder="输入自定义角色名称">
            </div>
            <div class="custom-field">
              <label for="custom-protagonist-desc">角色简介</label>
              <textarea id="custom-protagonist-desc" placeholder="简短描述你的角色特点、身份、背景等..."></textarea>
            </div>
            <button onclick="addCustomProtagonist()">确认添加</button>
          </div>
        </div>
      </div>

      <div class="selection-summary">
        <div class="selection-item">
          <div class="selection-label">性别:</div>
          <div class="selection-value" id="selected-gender">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">主角角色:</div>
          <div class="selection-value" id="selected-protagonist">未选择</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:20px;">
        <button onclick="goToStage(1)">返回</button>
        <button class="next-step" id="next-to-stage3" disabled>下一步</button>
      </div>
    </div>

    <!-- 第三阶段：互动对象选择 -->
    <div class="stage" id="stage3">
      <h2>选择互动对象</h2>
      <p style="text-align:center;">你可以从所有性别的角色中选择你希望在故事中互动的对象（可多选）</p>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('interaction-tab', 0)">男性角色</div>
          <div class="tab" onclick="switchTab('interaction-tab', 1)">女性角色</div>
          <div class="tab" onclick="switchTab('interaction-tab', 2)">自定义角色</div>
        </div>

        <div class="tab-content active" id="interaction-tab-0">
          <div class="multi-select-container" id="male-interactions">
            <!-- 男性角色选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectInteractions('male')">随机选择</button>
        </div>

        <div class="tab-content" id="interaction-tab-1">
          <div class="multi-select-container" id="female-interactions">
            <!-- 女性角色选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectInteractions('female')">随机选择</button>
        </div>

        <div class="tab-content" id="interaction-tab-2">
          <div class="custom-controls">
            <div class="custom-field">
              <label for="custom-interaction-name">角色名称</label>
              <input type="text" id="custom-interaction-name" placeholder="输入自定义互动角色名称">
            </div>
            <div class="custom-field">
              <label for="custom-interaction-gender">角色性别</label>
              <select id="custom-interaction-gender">
                <option value="male">男性</option>
                <option value="female">女性</option>
              </select>
            </div>
            <div class="custom-field">
              <label for="custom-interaction-desc">角色简介</label>
              <textarea id="custom-interaction-desc" placeholder="简短描述这个角色的特点、身份、背景等..."></textarea>
            </div>
            <button onclick="addCustomInteraction()">确认添加</button>
          </div>
        </div>
      </div>

      <div class="selection-summary">
        <div class="selection-item">
          <div class="selection-label">已选对象:</div>
          <div class="selection-value" id="selected-interactions">未选择</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:20px;">
        <button onclick="goToStage(2)">返回</button>
        <button class="next-step" id="next-to-stage4">下一步</button>
      </div>
    </div>

    <!-- 第四阶段：世界元素设置 -->
    <div class="stage" id="stage4">
      <h2>世界元素设置</h2>
      <p style="text-align:center;">选择或自定义你的主题、服装、行为和玩法元素</p>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('elements-tab', 0)">主题</div>
          <div class="tab" onclick="switchTab('elements-tab', 1)">服装</div>
          <div class="tab" onclick="switchTab('elements-tab', 2)">行为</div>
          <div class="tab" onclick="switchTab('elements-tab', 3)">玩法</div>
        </div>

        <div class="tab-content active" id="elements-tab-0">
          <div class="options-grid" id="theme-options">
            <!-- 主题选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectElement('theme')">随机选择</button>
          <div class="custom-controls">
            <div class="custom-field">
              <label>自定义主题</label>
              <input type="text" id="custom-theme-name" placeholder="输入自定义主题名称">
            </div>
            <div class="custom-field">
              <textarea id="custom-theme-desc" placeholder="简短描述这个主题的特点、背景、氛围等..."></textarea>
            </div>
            <button onclick="addCustomElement('theme')">添加自定义主题</button>
          </div>
        </div>

        <div class="tab-content" id="elements-tab-1">
          <div class="options-grid" id="costume-options">
            <!-- 服装选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectElement('costume')">随机选择</button>
          <div class="custom-controls">
            <div class="custom-field">
              <label>自定义服装</label>
              <input type="text" id="custom-costume-name" placeholder="输入自定义服装名称">
            </div>
            <div class="custom-field">
              <textarea id="custom-costume-desc" placeholder="描述这个服装的款式、材质、穿着效果等..."></textarea>
            </div>
            <button onclick="addCustomElement('costume')">添加自定义服装</button>
          </div>
        </div>

        <div class="tab-content" id="elements-tab-2">
          <div class="options-grid" id="behavior-options">
            <!-- 行为选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectElement('behavior')">随机选择</button>
          <div class="custom-controls">
            <div class="custom-field">
              <label>自定义行为</label>
              <input type="text" id="custom-behavior-name" placeholder="输入自定义行为名称">
            </div>
            <div class="custom-field">
              <textarea id="custom-behavior-desc" placeholder="描述这个行为的过程、感受、特点等..."></textarea>
            </div>
            <button onclick="addCustomElement('behavior')">添加自定义行为</button>
          </div>
        </div>

        <div class="tab-content" id="elements-tab-3">
          <div class="options-grid" id="play-options">
            <!-- 玩法选项将由JS动态生成 -->
          </div>
          <button class="random" onclick="randomSelectElement('play')">随机选择</button>
          <div class="custom-controls">
            <div class="custom-field">
              <label>自定义玩法</label>
              <input type="text" id="custom-play-name" placeholder="输入自定义玩法名称">
            </div>
            <div class="custom-field">
              <textarea id="custom-play-desc" placeholder="描述这个玩法的规则、步骤、情趣体验等..."></textarea>
            </div>
            <button onclick="addCustomElement('play')">添加自定义玩法</button>
          </div>
        </div>
      </div>

      <div class="selection-summary">
        <div class="selection-item">
          <div class="selection-label">已选主题:</div>
          <div class="selection-value" id="selected-theme">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">已选服装:</div>
          <div class="selection-value" id="selected-costume">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">已选行为:</div>
          <div class="selection-value" id="selected-behavior">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">已选玩法:</div>
          <div class="selection-value" id="selected-play">未选择</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:20px;">
        <button onclick="goToStage(3)">返回</button>
        <button class="next-step" id="next-to-stage5">下一步</button>
      </div>
    </div>

    <!-- 第五阶段：世界生成 -->
    <div class="stage" id="stage5">
      <h2>幻想世界汇总</h2>

      <div class="selection-summary" style="margin-bottom: 30px;">
        <div class="selection-item">
          <div class="selection-label">性别:</div>
          <div class="selection-value" id="summary-gender">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">
            <user>角色:
          </div>
          <div class="selection-value" id="summary-protagonist">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">互动对象:</div>
          <div class="selection-value" id="summary-interactions">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">主题:</div>
          <div class="selection-value" id="summary-theme">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">互动对象服装:</div>
          <div class="selection-value" id="summary-costume">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">行为:</div>
          <div class="selection-value" id="summary-behavior">未选择</div>
        </div>
        <div class="selection-item">
          <div class="selection-label">玩法:</div>
          <div class="selection-value" id="summary-play">未选择</div>
        </div>
      </div>

      <div class="action-buttons">
        <button onclick="sendToChat()">发送到AI开始冒险</button>
        <button onclick="goToStage(4)">返回修改</button>
      </div>
    </div>


    <script>
      // 数据存储
      const worldData = {
        playerGender: '',
        protagonist: { name: '', desc: '', isCustom: false },
        interactions: [],
        theme: { name: '', desc: '', isCustom: false },
        costume: { name: '', desc: '', isCustom: false },
        behavior: { name: '', desc: '', isCustom: false },
        play: { name: '', desc: '', isCustom: false }
      };

      // 由JSON提供的选项数据
      const optionsData = {
        "主题": [
          "恋爱喜剧", "出轨", "强姦", "乱伦", "温泉", "女同性恋",
          "企业", "相亲", "催眠", "洗澡", "其他动物", "虐恋",
          "性爱", "学校作品", "安眠", "M男", "脱粪", "植物群",
          "乳头舔", "调教", "运输", "制作/専門", "冒险", "机器人",
          "深海真実", "科幻小说", "SM", "汽车性爱", "学院作品",
          "企划", "乱闘", "疑惑", "運動", "其他植物", "肉系",
          "幻视", "矛盾", "男同性恋", "实录", "浪漫喜剧",
          "原文", "女同性爱", "3D", "流量", "人妻"
        ],

        "男性角色": [
          "男性强奸犯", "男性教师", "男性老板", "男性冒险者"
        ],

        "女性角色": [
          // 普通角色
          "女性学生", "女性护士", "女性秘书", "女性主妇",

          // Fate系列
          "伊什塔尔", "艾蕾", "黑贞德", "远坂凛", "间桐樱",
          "阿尔托莉雅(lancer)", "白贞德", "爱尔奎特·布伦史塔德",
          "沙条爱歌", "布伦希尔德", "梅莉", "玛丽",
          "埃列什基伽勒(Beast)", "太空伊什塔尔", "阿斯塔蒂",
          "迦摩", "皇女", "阿尔托莉雅", "提亚马特", "杜尔迦",
          "帕尔瓦蒂", "阿尔托莉雅(alter)", "斯卡哈",

          // 其他游戏/动漫角色
          "符玄", "云璃", "灵砂", "久远寺有珠", "阮梅",
          "花火", "黑天鹅", "布洛妮娅", "希儿", "伊莉雅",
          "美游", "虞美人", "蒂法", "爱丽丝", "摩根",
          "苍崎青子", "苍崎橙子", "尼托克丽丝", "卡莲",
          "两仪式", "葛饰北斋"
        ],

        "服装": [
          // 眼镜与配饰
          "眼镜", "猫耳", "身体链", "高跟鞋", "袜子", "绑腿",

          // 角色扮演
          "角色扮演", "COSPLAY制服", "女僕", "女战士", "女忍者",
          "OL", "泳装模特", "空中小姐", "宪兵", "女祭司", "动漫人物",
          "迷你裙警察", "福利彩色扮演", "女僕人派",

          // 常规服装
          "内衣", "制服", "水手服", "泳装", "和服", "围裙",
          "连裤袜", "运动鞋", "制服外套", "絲襪連褲襪", "学校泳装",
          "迷你裙", "浴衣", "紧身衣", "连衣裙", "校服", "水手套装",
          "螺旋紧身衣", "紧身", "日本衣服和浴衣", "娃娃"
        ],

        "行为": [
          // 性交类
          "乳交", "中出", "多P", "69", "上位", "口交", "肛交",
          "手指插入", "手淫", "深喉", "足交", "骑乘位", "二穴一同入",
          "一男两女", "两男一女", "按摩", "侵入", "按摩棒", "跳蛋", "SM",

          // 体液相关
          "潮吹", "颜射", "飲尿", "排便", "放尿", "喷射/精液", "集體噴射",

          // 亲密行为
          "接吻", "舌吻", "亲吻", "亲父", "约会",

          // 特殊状态
          "自慰", "圣母", "母乳", "食事", "剃毛", "打屁股", "不穿内褲",
          "不穿胸罩", "增加/健身", "白眼失神", "搔癢", "红門", "晚餐",
          "禁欲", "灌肠", "潮射", "轮姦", "拘束", "吞嚥", "酒飲",
          "捆绑/束缚", "差動", "骚手", "鞭责", "打手槍", "指导", "玩具"
        ],

        "玩法": [
          // 主要玩法
          "凌辱", "波霸", "捆绑", "監禁", "玩具", "SM", "户外",
          "乳液", "羞辱", "女僕按摩棒", "拘束", "调教", "立刻口交",
          "脱粪", "监禁", "被单", "插入異物", "灌腸", "露出", "汽車性愛",

          // 特殊玩法
          "催眠", "落語", "臭屎", "妹汁", "子宫颈", "骚婆", "暗黑",
          "睡眠波", "乳汁喷溅", "乳头", "足球", "辅助自助", "木塞交叠",
          "個器具", "自慰", "妊娠插入"
        ]
      };

      // 初始化页面
      document.addEventListener('DOMContentLoaded', function () {
        // 初始化选项列表
        initializeOptions();

        // 添加事件监听器
        document.getElementById('next-to-stage2').addEventListener('click', function () {
          goToStage(2);
        });
        document.getElementById('next-to-stage3').addEventListener('click', function () {
          goToStage(3);
        });
        document.getElementById('next-to-stage4').addEventListener('click', function () {
          goToStage(4);
        });
        document.getElementById('next-to-stage5').addEventListener('click', function () {
          goToStage(5);
          updateSummary(); // 更新汇总信息
        });
      });

      // 初始化选项
      function initializeOptions() {
        // 主题选项
        const themeOptions = document.getElementById('theme-options');
        optionsData.主题.forEach((theme, index) => {
          const option = document.createElement('div');
          option.className = 'option-item';
          option.textContent = theme;
          option.setAttribute('data-value', theme);
          option.onclick = function () {
            selectElement('theme', theme);
          };
          themeOptions.appendChild(option);
        });

        // 服装选项
        const costumeOptions = document.getElementById('costume-options');
        optionsData.服装.forEach((costume, index) => {
          const option = document.createElement('div');
          option.className = 'option-item';
          option.textContent = costume;
          option.setAttribute('data-value', costume);
          option.onclick = function () {
            selectElement('costume', costume);
          };
          costumeOptions.appendChild(option);
        });

        // 行为选项
        const behaviorOptions = document.getElementById('behavior-options');
        optionsData.行为.forEach((behavior, index) => {
          const option = document.createElement('div');
          option.className = 'option-item';
          option.textContent = behavior;
          option.setAttribute('data-value', behavior);
          option.onclick = function () {
            selectElement('behavior', behavior);
          };
          behaviorOptions.appendChild(option);
        });

        // 玩法选项
        const playOptions = document.getElementById('play-options');
        optionsData.玩法.forEach((play, index) => {
          const option = document.createElement('div');
          option.className = 'option-item';
          option.textContent = play;
          option.setAttribute('data-value', play);
          option.onclick = function () {
            selectElement('play', play);
          };
          playOptions.appendChild(option);
        });
      }

      // 性别选择
      function selectGender(gender) {
        worldData.playerGender = gender;
        document.querySelectorAll('.gender-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelector(`.gender-card[data-gender="${gender}"]`).classList.add('selected');
        document.getElementById('selected-gender').textContent = gender === 'male' ? '男性' : '女性';
        document.getElementById('next-to-stage2').disabled = false;

        // 准备角色选项
        populateProtagonistOptions();
      }

      // 填充主角角色选项
      function populateProtagonistOptions() {
        const grid = document.getElementById('protagonists-grid');
        grid.innerHTML = '';

        const characterList = worldData.playerGender === 'male'
          ? optionsData.男性角色
          : optionsData.女性角色;

        characterList.forEach(character => {
          const option = document.createElement('div');
          option.className = 'option-item';
          option.textContent = character;
          option.setAttribute('data-value', character);
          option.onclick = function () {
            selectProtagonist(character);
          };
          grid.appendChild(option);
        });
      }

      // 填充互动角色选项
      function populateInteractionOptions() {
        // 男性角色
        const maleContainer = document.getElementById('male-interactions');
        maleContainer.innerHTML = '';
        optionsData.男性角色.forEach((character, index) => {
          // 排除已选为主角的角色
          if (worldData.playerGender === 'male' && worldData.protagonist.name === character) return;

          const item = document.createElement('div');
          item.className = 'multi-select-item';
          item.innerHTML = `
          <input type="checkbox" id="male-char-${index}" value="${character}">
          <label for="male-char-${index}">${character}</label>
        `;
          item.querySelector('input').addEventListener('change', updateInteractions);
          maleContainer.appendChild(item);
        });

        // 女性角色
        const femaleContainer = document.getElementById('female-interactions');
        femaleContainer.innerHTML = '';
        optionsData.女性角色.forEach((character, index) => {
          // 排除已选为主角的角色
          if (worldData.playerGender === 'female' && worldData.protagonist.name === character) return;

          const item = document.createElement('div');
          item.className = 'multi-select-item';
          item.innerHTML = `
          <input type="checkbox" id="female-char-${index}" value="${character}">
          <label for="female-char-${index}">${character}</label>
        `;
          item.querySelector('input').addEventListener('change', updateInteractions);
          femaleContainer.appendChild(item);
        });
      }

      // 更新互动对象选择
      function updateInteractions() {
        worldData.interactions = [];

        // 收集所有选中的男性角色
        document.querySelectorAll('#male-interactions input:checked').forEach(input => {
          worldData.interactions.push({
            name: input.value,
            gender: 'male',
            isCustom: false
          });
        });

        // 收集所有选中的女性角色
        document.querySelectorAll('#female-interactions input:checked').forEach(input => {
          worldData.interactions.push({
            name: input.value,
            gender: 'female',
            isCustom: false
          });
        });

        // 更新显示
        const interactionsText = worldData.interactions.length > 0
          ? worldData.interactions.map(i => i.name).join(', ')
          : '未选择';
        document.getElementById('selected-interactions').textContent = interactionsText;
      }

      // 选择主角角色
      function selectProtagonist(characterName) {
        // 清除之前的选择
        document.querySelectorAll('#protagonists-grid .option-item').forEach(option => {
          option.classList.remove('selected');
        });

        // 设置新选择
        document.querySelector(`#protagonists-grid .option-item[data-value="${characterName}"]`).classList.add('selected');
        worldData.protagonist = {
          name: characterName,
          desc: '',
          isCustom: false
        };

        // 更新显示
        document.getElementById('selected-protagonist').textContent = characterName;
        document.getElementById('next-to-stage3').disabled = false;
      }

      // 添加自定义主角
      function addCustomProtagonist() {
        const name = document.getElementById('custom-protagonist-name').value.trim();
        const desc = document.getElementById('custom-protagonist-desc').value.trim();

        if (name === '') {
          alert('请输入角色名称');
          return;
        }

        worldData.protagonist = {
          name: name,
          desc: desc,
          isCustom: true
        };

        // 更新显示
        document.getElementById('selected-protagonist').textContent = `${name} (自定义)`;
        document.getElementById('next-to-stage3').disabled = false;

        // 清空输入框
        document.getElementById('custom-protagonist-name').value = '';
        document.getElementById('custom-protagonist-desc').value = '';

        // 切换回列表选项卡
        switchTab('protagonist-tab', 0);
      }

      // 添加自定义互动角色
      function addCustomInteraction() {
        const name = document.getElementById('custom-interaction-name').value.trim();
        const gender = document.getElementById('custom-interaction-gender').value;
        const desc = document.getElementById('custom-interaction-desc').value.trim();

        if (name === '') {
          alert('请输入角色名称');
          return;
        }

        // 添加到互动列表
        worldData.interactions.push({
          name: name,
          gender: gender,
          desc: desc,
          isCustom: true
        });

        // 更新显示
        const interactionsText = worldData.interactions.map(i => i.name).join(', ');
        document.getElementById('selected-interactions').textContent = interactionsText;

        // 清空输入框
        document.getElementById('custom-interaction-name').value = '';
        document.getElementById('custom-interaction-desc').value = '';

        // 切换回列表选项卡
        switchTab('interaction-tab', gender === 'male' ? 0 : 1);
      }

      // 随机选择主角
      function randomSelectProtagonist() {
        const characterList = worldData.playerGender === 'male'
          ? optionsData.男性角色
          : optionsData.女性角色;

        const randomIndex = Math.floor(Math.random() * characterList.length);
        selectProtagonist(characterList[randomIndex]);
      }

      // 随机选择互动对象
      function randomSelectInteractions(gender) {
        const characterList = gender === 'male' ? optionsData.男性角色 : optionsData.女性角色;
        const count = Math.floor(Math.random() * 3) + 1; // 随机选择1-3个

        // 清除当前该性别的选择
        document.querySelectorAll(`#${gender}-interactions input`).forEach(input => {
          input.checked = false;
        });

        // 随机选择新的
        const shuffled = [...characterList].sort(() => 0.5 - Math.random());
        const selectedCharacters = shuffled.slice(0, count);

        for (const character of selectedCharacters) {
          const input = document.querySelector(`#${gender}-interactions input[value="${character}"]`);
          if (input) input.checked = true;
        }

        // 更新互动列表
        updateInteractions();
      }

      // 选择世界元素
      function selectElement(type, value) {
        // 清除之前的选择
        document.querySelectorAll(`#${type}-options .option-item`).forEach(option => {
          option.classList.remove('selected');
        });

        // 设置新选择
        document.querySelector(`#${type}-options .option-item[data-value="${value}"]`).classList.add('selected');

        worldData[type] = {
          name: value,
          desc: '',
          isCustom: false
        };

        // 更新显示
        document.getElementById(`selected-${type}`).textContent = value;
      }

      // 添加自定义元素
      function addCustomElement(type) {
        const nameInput = document.getElementById(`custom-${type}-name`);
        const descInput = document.getElementById(`custom-${type}-desc`);
        const name = nameInput.value.trim();
        const desc = descInput.value.trim();

        if (name === '') {
          alert('请输入名称');
          return;
        }

        worldData[type] = {
          name: name,
          desc: desc,
          isCustom: true
        };

        // 更新显示
        document.getElementById(`selected-${type}`).textContent = `${name} (自定义)`;

        // 清空输入框
        nameInput.value = '';
        descInput.value = '';
      }

      // 随机选择元素
      function randomSelectElement(type) {
        let list;
        switch (type) {
          case 'theme': list = optionsData.主题; break;
          case 'costume': list = optionsData.服装; break;
          case 'behavior': list = optionsData.行为; break;
          case 'play': list = optionsData.玩法; break;
        }

        const randomIndex = Math.floor(Math.random() * list.length);
        selectElement(type, list[randomIndex]);
      }

      // 切换标签页
      function switchTab(tabGroupId, tabIndex) {
        // 隐藏所有标签内容
        document.querySelectorAll(`#${tabGroupId}-0, #${tabGroupId}-1, #${tabGroupId}-2, #${tabGroupId}-3`).forEach(content => {
          content.classList.remove('active');
        });

        // 取消所有标签的活跃状态
        document.querySelectorAll(`.tab`).forEach(tab => {
          if (tab.getAttribute('onclick').includes(tabGroupId)) {
            tab.classList.remove('active');
          }
        });

        // 激活选中的标签和内容
        document.getElementById(`${tabGroupId}-${tabIndex}`).classList.add('active');
        document.querySelectorAll(`.tab`).forEach((tab, index) => {
          if (tab.getAttribute('onclick').includes(`${tabGroupId}, ${tabIndex}`)) {
            tab.classList.add('active');
          }
        });

        // 针对标签组的特别处理
        const tabs = document.querySelectorAll(`.tabs .tab`);
        tabs.forEach((tab, index) => {
          if (tab.getAttribute('onclick').includes(`${tabGroupId}, ${tabIndex}`)) {
            tab.classList.add('active');
          }
        });
      }

      // 前往指定阶段
      function goToStage(stage) {
        // 隐藏所有阶段
        document.querySelectorAll('.stage').forEach(s => {
          s.classList.remove('active');
        });

        // 显示目标阶段
        document.getElementById('stage' + stage).classList.add('active');

        // 更新进度指示器状态
        updateProgressSteps(stage);

        // 当进入互动对象选择阶段时，填充互动对象选项
        if (stage === 3) {
          populateInteractionOptions();
        }

        // 完成互动对象选择后，继续下一步不需要禁用
        if (stage === 4) {
          document.getElementById('next-to-stage5').disabled = false;
        }
      }

      // 更新进度指示器
      function updateProgressSteps(currentStage) {
        // 将所有步骤重置为未完成
        document.querySelectorAll('.progress-step').forEach((step, index) => {
          if (index + 1 < currentStage) {
            step.classList.add('completed');
            step.classList.remove('active');
          } else if (index + 1 === currentStage) {
            step.classList.add('active');
            step.classList.remove('completed');
          } else {
            step.classList.remove('active', 'completed');
          }
        });
      }

      // 生成世界描述
      function generateWorld() {
        // 显示加载动画
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-content').style.display = 'none';

        setTimeout(() => {
          // 生成世界描述和剧情预测
          const { worldDesc, storyPreview } = createWorldAndStoryDescription();

          // 显示结果
          document.getElementById('world-description').innerHTML = worldDesc;
          document.getElementById('story-preview').innerHTML = storyPreview;

          // 隐藏加载动画，显示结果内容
          document.getElementById('loading').style.display = 'none';
          document.getElementById('result-content').style.display = 'block';

          // 存储到聊天变量中，以便后续使用
          triggerSlash(`/setvar key=worldDesc "${worldDesc}"`);
          triggerSlash(`/setvar key=storyPreview "${storyPreview}"`);
        }, 2000);
      }

      // 创建世界描述和剧情预测
      function createWorldAndStoryDescription() {
        // 从选中的元素创建描述
        const protagonistInfo = worldData.protagonist.isCustom ?
          `${worldData.protagonist.name}（${worldData.protagonist.desc}）` :
          worldData.protagonist.name;

        const interactionsInfo = worldData.interactions.length > 0 ?
          worldData.interactions.map(i => i.isCustom ? `${i.name}（${i.desc}）` : i.name).join('、') :
          '无';

        const themeInfo = worldData.theme.isCustom ?
          `${worldData.theme.name}（${worldData.theme.desc}）` :
          worldData.theme.name;

        const costumeInfo = worldData.costume.isCustom ?
          `${worldData.costume.name}（${worldData.costume.desc}）` :
          worldData.costume.name;

        const behaviorInfo = worldData.behavior.isCustom ?
          `${worldData.behavior.name}（${worldData.behavior.desc}）` :
          worldData.behavior.name;

        const playInfo = worldData.play.isCustom ?
          `${worldData.play.name}（${worldData.play.desc}）` :
          worldData.play.name;

        // 性别描述
        const genderDesc = worldData.playerGender === 'male' ? '男性' : '女性';

        // 随机生成世界描述 - 根据选中的元素创建一个充满色情元素的世界描述
        const worldDesc = generateWorldDescription(genderDesc, protagonistInfo, interactionsInfo, themeInfo, costumeInfo, behaviorInfo, playInfo);

        // 随机生成剧情预测 - 根据选中的元素创建一个充满色情元素的剧情梗概预测
        const storyPreview = generateStoryPreview(genderDesc, protagonistInfo, interactionsInfo, themeInfo, costumeInfo, behaviorInfo, playInfo);

        return { worldDesc, storyPreview };
      }

      // 生成世界描述
      function generateWorldDescription(gender, protagonist, interactions, theme, costume, behavior, play) {
        // 创建基本描述
        let descriptions = [
          `这是一个以${theme}为主题的幻想世界，你将作为一个${gender}角色${protagonist}进入这个充满诱惑与欲望的空间。`,
          `进入${theme}的奇妙世界，你将扮演${gender}角色${protagonist}，在这个世界里探索最深层的欲望。`,
          `欢迎来到${theme}的禁忌领域，作为${gender}角色${protagonist}，你将体验前所未有的刺激与快感。`,
          `这是一个由${theme}构建的幻想乐园，你作为${gender}角色${protagonist}将在此释放你最隐秘的渴望。`
        ];

        let baseDesc = descriptions[Math.floor(Math.random() * descriptions.length)];

        // 添加互动对象描述
        let interactionDescs = [
          `在这个世界里，${interactions}将成为你的互动对象，引导你探索未知的情欲世界。`,
          `${interactions}将在你的旅程中扮演重要角色，带给你极致的官能体验。`,
          `你将与${interactions}发生密切互动，共同探索身体与灵魂的极限。`,
          `${interactions}的存在将使你的体验更加丰富多彩，让你沉浸在无尽的快感中。`
        ];

        let interactionDesc = interactions === '无' ? '' : interactionDescs[Math.floor(Math.random() * interactionDescs.length)];

        // 添加服装描述
        let costumeDescs = [
          `你将穿着${costume}，这种装扮不仅展示了你的魅力，还能激发他人最原始的欲望。`,
          `精心设计的${costume}将包裹着你的身体，若隐若现地透露着诱人的曲线。`,
          `${costume}的触感与视觉效果将为你的体验增添一层神秘与刺激。`,
          `穿上${costume}，你的每一个动作都将充满诱惑，引得他人无法挪开视线。`
        ];

        let costumeDesc = costumeDescs[Math.floor(Math.random() * costumeDescs.length)];

        // 添加行为描述
        let behaviorDescs = [
          `在这个世界中，${behavior}将成为你探索欲望的主要方式，带给你前所未有的快感。`,
          `${behavior}的特殊体验将让你沉浸在极致的感官刺激之中，无法自拔。`,
          `通过${behavior}，你将发现自己身体的新可能，体验到前所未有的高潮。`,
          `${behavior}将成为你在这个世界中的主要互动方式，每一次都是独特的体验。`
        ];

        let behaviorDesc = behaviorDescs[Math.floor(Math.random() * behaviorDescs.length)];

        // 添加玩法描述
        let playDescs = [
          `世界的规则围绕${play}展开，这种独特的玩法将带给你极致的身心愉悦。`,
          `${play}的特殊规则将让你体验到禁忌的刺激，探索欲望的新边界。`,
          `在${play}的框架下，你将发现自己隐藏的欲望，体验前所未有的快感。`,
          `${play}将引导你探索自己未知的一面，在快感中不断突破自我。`
        ];

        let playDesc = playDescs[Math.floor(Math.random() * playDescs.length)];

        // 组合所有描述
        let finalDesc = `${baseDesc} ${interactionDesc} ${costumeDesc} ${behaviorDesc} ${playDesc}\n\n这个世界没有普通社会的道德约束，只有欲望的释放与满足。在这里，你可以尽情探索自己的幻想，体验各种刺激与快感。每一次互动都将带给你新的惊喜与体验，让你沉醉其中，欲罢不能。`;

        return finalDesc;
      }

      // 生成剧情预测
      function generateStoryPreview(gender, protagonist, interactions, theme, costume, behavior, play) {
        // 角色名称处理
        const mainCharacter = protagonist.includes('（') ? protagonist.split('（')[0] : protagonist;
        const otherCharacters = interactions === '无' ?
          ['神秘人物', '陌生人', '未知角色'][Math.floor(Math.random() * 3)] :
          interactions.split('、')[0].includes('（') ?
            interactions.split('、')[0].split('（')[0] :
            interactions.split('、')[0];

        // 场景选择
        const scenes = [
          '私密的卧室', '豪华的套房', '偏僻的森林', '神秘的地下室',
          '高级酒店', '私人泳池', '温泉旅馆', '办公室的角落',
          '空无一人的教室', '月光下的沙滩', '豪华游艇的甲板上', '隐蔽的温泉'
        ];
        const scene = scenes[Math.floor(Math.random() * scenes.length)];

        // 创建开场
        const openings = [
          `在这个以${theme}为主题的世界里，身为${mainCharacter}的你正穿着${costume}，在${scene}中遇见了${otherCharacters}。`,
          `${mainCharacter}的你刚刚换上了诱人的${costume}，正在${scene}中等待着什么，这时${otherCharacters}出现在你面前。`,
          `穿着${costume}的你在${scene}中漫步，突然感受到一道灼热的目光，那是${otherCharacters}正在注视着你。`,
          `身着${costume}的${mainCharacter}不知怎么来到了${scene}，${otherCharacters}的出现让情况变得更加复杂而刺激。`
        ];
        const opening = openings[Math.floor(Math.random() * openings.length)];

        // 创建中段
        const middles = [
          `随着气氛逐渐升温，你们开始尝试${behavior}，空气中弥漫着难以抵抗的欲望气息。`,
          `在一番交流后，${otherCharacters}提议尝试${behavior}，你发现自己无法拒绝这样的诱惑。`,
          `你主动提出想要体验${behavior}，${otherCharacters}的眼中闪过一丝惊讶，随后是浓烈的欲望。`,
          `当${otherCharacters}的手轻抚过你的身体时，你明白接下来将发生的${behavior}会让你无法自拔。`
        ];
        const middle = middles[Math.floor(Math.random() * middles.length)];

        // 创建高潮
        const climaxes = [
          `在${play}的规则下，你们的互动变得越来越深入，每一次触碰都带来前所未有的快感。`,
          `随着${play}的进行，你发现自己沉浸在一种前所未有的愉悦中，无法自拔。`,
          `${play}的独特体验让你忘记了一切，只剩下身体与感官的极致享受。`,
          `在${play}的引导下，你体验到了灵魂与肉体的双重高潮，那种感觉无法用言语形容。`
        ];
        const climax = climaxes[Math.floor(Math.random() * climaxes.length)];

        // 创建结尾
        const endings = [
          `当一切结束时，你知道这只是开始，在这个世界中还有更多未知的快感等待你去探索...",`,
          `汗水浸湿了${costume}，你躺在那里，思考着下一次会是什么样的体验...",`,
          `你们相视而笑，知道这只是这个奇妙世界的第一章，更多的冒险还在等待着你们...",`,
          `当你恢复意识时，你知道你已经爱上了这个世界，这里的每一次体验都让你欲罢不能..."`,
        ];
        const ending = endings[Math.floor(Math.random() * endings.length)];

        // 组合成完整的剧情预测
        return `${opening}\n\n${middle}\n\n${climax}\n\n${ending}`;
      }

      // 重新生成世界
      function regenerateWorld() {
        generateWorld();
      }

      // 将生成的内容发送到聊天
      function sendToChat() {
        // 获取玩家名称和描述
        const playerName = worldData.protagonist.name;
        const playerDesc = worldData.protagonist.desc;

        // 创建命令数组
        const commands = [];

        // 格式化要发送的消息
        let outputMessage = `新的冒险者加入了淫欲迷宫\n\n`;
        outputMessage += `姓名：${playerName}\n`;
        if (playerDesc) outputMessage += `背景：${playerDesc}\n`;

        // 添加主角的性别
        outputMessage += `性别：${worldData.playerGender === 'male' ? '男性' : '女性'}\n`;

        // 添加互动对象信息
        if (worldData.interactions.length > 0) {
          outputMessage += `互动对象：${worldData.interactions.map(i => i.name).join('、')}\n`;
        }

        // 添加主题信息
        outputMessage += `主题：${worldData.theme.name}\n`;

        // 添加服装信息
        outputMessage += `服装：${worldData.costume.name}\n`;

        // 添加行为信息
        outputMessage += `行为：${worldData.behavior.name}\n`;

        // 添加玩法信息
        outputMessage += `玩法：${worldData.play.name}\n`;

        // 将命令添加到数组中
        commands.push(`/send ${outputMessage}`);
        commands.push('/trigger');

        // 执行命令
        if (typeof triggerSlash === 'function') {
          triggerSlash(commands.join('|'));
        } else {
          console.log('Commands to execute:', commands.join('|'));
        }
      }

      // 使用SillyTavern的斜杠命令
      function triggerSlash(command) {
        // 此函数会在iframe内部调用父窗口的斜杠命令执行器
        if (window.parent) {
          try {
            window.parent.postMessage({
              type: 'run_slash_commands',
              commands: command
            }, '*');
          } catch (error) {
            console.error('执行斜杠命令失败:', error);
          }
        }
      }
      // 更新汇总信息
      function updateSummary() {
        document.getElementById('summary-gender').textContent = worldData.playerGender === 'male' ? '男性' : '女性';

        const protagonistInfo = worldData.protagonist.isCustom ?
          `${worldData.protagonist.name} (自定义)` :
          worldData.protagonist.name;
        document.getElementById('summary-protagonist').textContent = protagonistInfo;

        const interactionsInfo = worldData.interactions.length > 0 ?
          worldData.interactions.map(i => i.isCustom ? `${i.name} (自定义)` : i.name).join(', ') :
          '未选择';
        document.getElementById('summary-interactions').textContent = interactionsInfo;

        document.getElementById('summary-theme').textContent = worldData.theme.isCustom ?
          `${worldData.theme.name} (自定义)` : worldData.theme.name;

        document.getElementById('summary-costume').textContent = worldData.costume.isCustom ?
          `${worldData.costume.name} (自定义)` : worldData.costume.name;

        document.getElementById('summary-behavior').textContent = worldData.behavior.isCustom ?
          `${worldData.behavior.name} (自定义)` : worldData.behavior.name;

        document.getElementById('summary-play').textContent = worldData.play.isCustom ?
          `${worldData.play.name} (自定义)` : worldData.play.name;
      }
    </script>
</body>

</html>