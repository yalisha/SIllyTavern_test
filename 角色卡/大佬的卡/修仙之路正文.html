```
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>修仙界面</title>
  <style>
    @import url('https://static.zeoseven.com/zsft/235/main/result.css');

    :root {
      --global-font: "chengrongguangke";
    }

    body {
      margin: 0;
      padding: 0;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%234CAF50" stroke-width="2"><path d="M12 2L2 12l10 10 10-10L12 2z"/></svg>') 12 12, auto;
      height: 800px;
      background: url('https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1734444679152.gif')no-repeat center center fixed;
      background-size: cover;
      font-family: var(--global-font);
      color: #333;
    }

    button,
    a,
    select,
    input[type="range"],
    input[type="color"] {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%234CAF50" stroke="%234CAF50"><circle cx="12" cy="12" r="6"/></svg>') 12 12, pointer;
    }

    .nav-bar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(to right, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .nav-button {
      margin: 0 20px;
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: 18px;
      color: #333;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nav-button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: #000;
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }

    .nav-button:hover {
      color: #000;
    }

    .nav-button:hover::after {
      width: 80%;
    }

    .nav-button.active {
      color: #000;
    }

    .nav-button.active::after {
      width: 80%;
    }

    .content {
      margin-top: 80px;
      padding: 20px;

      min-height: calc(100vh - 100px);
    }

    /* 自定义滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #4CAF50, #8BC34A);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #45a049, #7cb342);
      border: 1px solid transparent;
      background-clip: padding-box;
    }

    .panel {
      display: none;
      background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      backdrop-filter: blur(10px);
      border-radius: 10px;
      scrollbar-width: thin;
      scrollbar-color: #4CAF50 rgba(255, 255, 255, 0.1);
      padding: 10px;
      font-family: inherit;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease;
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .interaction-history {
      scrollbar-width: thin;
      scrollbar-color: #4CAF50 rgba(255, 255, 255, 0.1);
    }

    .status-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-item {
      display: flex;
      font-family: inherit;
      flex-direction: column;
      align-items: flex-start;
    }

    .status-label {
      font-size: 0.9em;
      color: #666;
    }

    .status-value {
      font-size: 1.1em;
      color: #000;
    }

    .progress-bar {
      width: 150px;
      height: 15px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 7px;
      margin: 5px 0;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }

    .progress {
      height: 100%;
      background: linear-gradient(to right, #4CAF50, #8BC34A);
      border-radius: 7px;
      transition: width 0.3s ease;
    }

    .skill-item,
    .artifact-item {
      margin: 10px 0;
      font-family: inherit;
      padding: 10px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
    }

    .skill-header,
    .artifact-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-btn {
      padding: 5px 15px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      cursor: pointer;
      font-family: var(--global-font);
      color: #333;
      font-size: 0.9em;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .detail-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .detail-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      color: #000;
    }

    .detail-btn:hover::before {
      left: 100%;
    }

    .detail-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .skill-details {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
    }

    /* 关系系统样式 */
    .relationship-category {
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
    }

    .relationship-category h3 {
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .relationship-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .relationship-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
      position: relative;
    }

    .relationship-item:hover {
      transform: translateX(10px);
      background: rgba(255, 255, 255, 0.3);
    }

    .character-name {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .favor-value {
      font-size: 0.9em;
      font-weight: normal;
      color: #666;
    }

    .character-info {
      color: #444;
      margin-bottom: 5px;
    }

    .character-status {
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }

    .character-details {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .detail-section {
      margin-bottom: 15px;
    }

    .detail-section h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .interaction-history {
      max-height: 150px;
      overflow-y: auto;
    }

    .interaction-item {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
      font-size: 0.9em;
    }

    .interaction-date {
      color: #666;
      min-width: 120px;
    }

    .detail-toggle {
      padding: 5px 15px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      cursor: pointer;
      font-family: var(--global-font);
      color: #333;
      font-size: 0.9em;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .detail-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .detail-toggle:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      color: #000;
    }

    .detail-toggle:hover::before {
      left: 100%;
    }

    .detail-toggle:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .hostile {
      background: rgba(244, 67, 54, 0.1);
    }

    .social-controls {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .search-box input {
      padding: 8px 15px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      width: 200px;

    }

    .filter-controls {
      display: flex;
      gap: 10px;
    }

    .filter-controls select {
      padding: 8px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 4px;

    }

    /* 在已有的style标签内添加以下样式 */
    .cultivation-system {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
    }

    .attributes-section {
      margin: 20px 0;
    }

    .radar-chart {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 20px auto;
    }

    .radar-chart canvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    .attributes-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }

    .attribute-item {
      flex: 1 1 calc(33.33% - 10px);
      min-width: 150px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      text-align: center;
    }

    .attribute-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .attribute-value {
      color: #4CAF50;
    }

    /* 大事记时间线样式 */
    .timeline-header {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: right;
      font-size: 0.9em;
      color: #666;
    }

    .timeline-container {
      position: relative;
      padding: 20px 0;
      margin-left: 50px;
    }

    .timeline-line {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2));
    }

    .timeline-event {
      position: relative;
      font-family: inherit;
      margin-bottom: 30px;
      padding-left: 30px;
      transition: all 0.3s ease;
    }

    .timeline-event:hover {
      transform: translateX(10px);
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #4CAF50;
    }

    .timeline-date {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }

    .timeline-content {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .timeline-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }

    .timeline-description {
      font-size: 0.95em;
      color: #444;
    }

    .timeline-impact {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }

    .timeline-tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 3px;
      font-size: 0.8em;
      color: #4CAF50;
      margin-right: 5px;
    }

    .skill-header strong {
      font-size: 1.1em;
      margin-right: 8px;
    }

    .skill-header em {
      font-style: italic;
      color: #666;
      font-size: 0.9em;
    }

    .skill-details {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      line-height: 1.5;
    }

    .skill-details p {
      margin: 5px 0;
    }

    /* 设置面板*/
    .settings-section {
      padding: 20px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .settings-group {
      margin-bottom: 15px;
    }

    .settings-group h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .setting-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }

    .setting-label {
      flex: 1;
      margin-right: 15px;
    }

    .setting-control {
      flex: 2;
    }

    .setting-control input[type="range"] {
      width: 100%;
    }

    .setting-control select {
      width: 100%;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      margin-left: 10px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* 宗门信息样式 */
    .sect-content {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .sect-basic {
      grid-column: 1 / -1;
    }

    .story-content {
      line-height: 1.8;
      padding: 20px;
    }

    .story-content p {
      text-indent: 2em;
      margin: 1em 0;
      text-align: justify;
    }

    /* 平板设备 - 屏幕宽度小于 1024px */
    @media screen and (max-width: 1024px) {
      .nav-bar {
        height: 50px;
      }

      .nav-button {
        margin: 0 10px;
        padding: 8px 15px;
        font-size: 16px;
      }

      .panel {
        width: 95%;
        margin: 15px auto;
      }

      .status-bar {
        grid-template-columns: repeat(2, 1fr);
      }

      .radar-chart {
        width: 250px;
        height: 250px;
      }

      .attributes-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .sect-content {
        grid-template-columns: 1fr;
      }
    }

    /* 手机设备 - 屏幕宽度小于 768px */
    @media screen and (max-width: 768px) {
      .nav-bar {
        height: auto;
        padding: 5px;
        flex-wrap: wrap;
      }

      .nav-button {
        margin: 5px;
        padding: 6px 12px;
        font-size: 14px;
        flex: 1 1 calc(33.33% - 10px);
        text-align: center;
      }

      .content {
        margin-top: 120px;
        padding: 10px;
      }

      .panel {
        width: 100%;
        margin: 10px auto;
        padding: 10px;
      }

      .status-bar {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .radar-chart {
        width: 200px;
        height: 200px;
      }

      .attributes-list {
        grid-template-columns: 1fr;
      }

      .relationship-item {
        padding: 15px;
      }

      .timeline-container {
        margin-left: 30px;
      }

      .timeline-event {
        padding-left: 20px;
      }

      .setting-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .setting-label {
        margin-bottom: 5px;
      }

      .setting-control {
        width: 100%;
      }
    }

    /* 小型手机设备 - 屏幕宽度小于 480px */
    @media screen and (max-width: 480px) {
      .nav-button {
        font-size: 12px;
        padding: 5px 8px;
      }

      .content {
        margin-top: 140px;
        padding: 5px;
      }

      .radar-chart {
        width: 180px;
        height: 180px;
      }

      .skill-item,
      .artifact-item {
        padding: 8px;
      }

      .skill-header,
      .artifact-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .detail-btn {
        margin-top: 5px;
        width: 100%;
        text-align: center;
      }

      .timeline-event::before {
        width: 8px;
        height: 8px;
      }

      .timeline-content {
        padding: 10px;
      }

      .search-box input {
        width: 100%;
      }

      .filter-controls {
        width: 100%;
      }

      .filter-controls select {
        width: 100%;
      }
    }

    /* 处理横屏模式 */
    @media screen and (max-height: 600px) and (orientation: landscape) {
      .nav-bar {
        position: static;
        margin-bottom: 10px;
      }

      .content {
        margin-top: 10px;
      }

      .panel {
        max-height: none;
      }

      .radar-chart {
        width: 200px;
        height: 200px;
      }
    }

    /* 优化触摸设备交互 */
    @media (hover: none) and (pointer: coarse) {

      .nav-button,
      .detail-btn,
      .detail-toggle,
      .setting-control input,
      .setting-control select {
        min-height: 44px;
        min-width: 44px;
      }

      .skill-header,
      .artifact-header {
        gap: 10px;
      }

      .relationship-item:hover {
        transform: none;
      }

      .timeline-event:hover {
        transform: none;
      }

      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }
    }

    .reset-settings-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: var(--global-font);
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    .reset-settings-btn:hover {
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      transform: translateY(-2px);
    }

    .reset-settings-btn:active {
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <nav class="nav-bar">
    <button class="nav-button active" data-panel="content">正文</button>
    <button class="nav-button" data-panel="character">主角信息</button>
    <button class="nav-button" data-panel="social">交际</button>
    <button class="nav-button" data-panel="events">大事记</button>
    <button class="nav-button" data-panel="sect">宗门</button>
    <button class="nav-button" data-panel="setting">设置</button>
  </nav>

  <div class="content">
    <!-- 正文面板 -->
    <div class="panel active" id="content">
      <!-- 内容由JavaScript动态生成 -->
    </div>

    <!-- 主角信息面板 -->
    <div class="panel" id="character">
      <!-- 内容由JavaScript动态生成 -->
    </div>

    <!-- 交际面板 -->
    <div class="panel" id="social">
      <!-- 内容由JavaScript动态生成 -->
    </div>

    <!-- 大事记面板 -->
    <div class="panel" id="events">
      <!-- 内容由JavaScript动态生成 -->
    </div>

    <!-- 宗门面板 -->
    <div class="panel" id="sect">
      <!-- 内容由JavaScript动态生成 -->
    </div>

    <!-- 设置面板 -->
    <div class="panel" id="setting">
      <h2>界面设置</h2>
      <div class="setting-section">
        <h3>字体设置</h3>
        <div class="setting-item">
          <select id="fontSelect">
            <option value="chengrongguangke">承荣光刻</option>
            <option value="songti">宋体</option>
            <option value="kaiti">楷体</option>
          </select>
        </div>
        <div class="setting-item">
          <label>字体大小：</label>
          <input type="range" id="fontSize" min="10" max="35" value="16">
          <span id="fontSizeValue">19px</span>
        </div>
      </div>
      <div class="setting-section">
        <button class="reset-settings-btn" onclick="resetAndApplySettings()">重置所有设置</button>
      </div>
      <div class="setting-section">
        <h3>窗口设置</h3>
        <div class="setting-item">
          <label>窗口颜色：</label>
          <input type="color" id="windowColor" value="#ffffff">
          <div class="color-preview" id="windowColorPreview"></div>
        </div>
        <div class="setting-item">
          <label>窗口透明度：</label>
          <input type="range" id="windowOpacity" min="0" max="100" value="81">
          <span id="opacityValue">95%</span>
        </div>
      </div>
      <div class="setting-section">
        <button class="save-archive-btn" onclick="saveArchive()">存档</button>
      </div>
    </div>
  </div>

  <script>
    // 定义游戏文本模板
    let gameText = `<gametext>$1</gametext>`;

    // ==================== 数据提取模块 ====================
    const DataExtractor = {
      extractMainContent(text) {
        const match = text.match(/<maincontent>([\s\S]*?)<\/maincontent>/);
        if (!match) return null;

        try {
          const content = {};
          const lines = match[1].trim().split('\n');

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            if (line.startsWith('当前章节正文|')) {
              // 提取正文内容，从当前行开始到下一个标签或结束
              let storyContent = [];
              let j = i;

              // 获取第一行的内容（去掉"当前章节正文|"前缀）
              const firstContent = line.substring(line.indexOf('|') + 1).trim();
              if (firstContent) storyContent.push(firstContent);

              // 继续读取后续行，直到遇到新的标签或结束
              j++;
              while (j < lines.length && !lines[j].includes('</maincontent>')) {
                const content = lines[j].trim();
                if (content && !content.includes('|')) {
                  storyContent.push(content);
                }
                j++;
              }

              // 将所有段落用<p>标签包裹
              content.content = storyContent
                .filter(p => p.trim())
                .map(p => `<p>${p.trim()}</p>`)
                .join('');

              // 保存原始格式的文本（包含"当前章节正文|"）
              content.rawContent = line + '\n' + storyContent.join('\n');

              i = j - 1; // 更新索引
            } else {
              const [key, value] = line.split('|').map(s => s.trim());
              content[key === '当前章节标题' ? 'title' :
                key === '当前时间' ? 'time' :
                  key === '当前位置' ? 'location' :
                    key === '当前财产' ? 'wealth' : key] = value;
            }
          }

          return content;
        } catch (e) {
          console.error('解析主体内容失败:', e);
          return null;
        }
      },

      extractCharacterInfo(text) {
        const match = text.match(/<characterinfo>([\s\S]*?)<\/characterinfo>/);
        if (!match) return null;

        try {
          const info = {
            basic: {},
            cultivation: {},
            attributes: {},
            realm: {},
            skills: [],
            artifacts: [],
            backpack: []
          };

          const lines = match[1].trim().split('\n');
          let currentSkill = {};

          lines.forEach(line => {
            const [category, key, ...values] = line.split('|').map(s => s.trim());

            switch (category) {
              case '基本信息':
                info.basic[key] = values[0];
                break;
              case '修炼体系':
                info.cultivation[key] = values[0];
                break;
              case '属性':
                info.attributes[key] = parseInt(values[0]);
                break;
              case '境界':
                info.realm[key] = values[0];
                break;
              case '功法':
                if (key === '名称') currentSkill = {};
                currentSkill[key] = values[0];
                if (key === '效果') {
                  info.skills.push({ ...currentSkill });
                }
                break;
              case '法宝':
                if (key === '名称') currentSkill = {};
                currentSkill[key] = values[0];
                if (key === '效果') {
                  info.artifacts.push({ ...currentSkill });
                }
                break;
              case '背包':
                info.backpack.push({
                  name: key,
                  description: values[0],
                  quantity: values[1]
                });
                break;
            }
          });

          return info;
        } catch (e) {
          console.error('解析主角信息失败:', e);
          return null;
        }
      },

      extractSocialInfo(text) {
        const match = text.match(/<socialinfo>([\s\S]*?)<\/socialinfo>/);
        if (!match) return null;

        try {
          const relationships = {};
          let currentType = '';
          let currentCharacter = null;

          const lines = match[1].trim().split('\n');

          lines.forEach(line => {
            const [category, key, value] = line.split('|').map(s => s.trim());

            if (category === '关系类型') {
              if (currentCharacter) {
                if (!relationships[currentType]) {
                  relationships[currentType] = [];
                }
                relationships[currentType].push(currentCharacter);
              }
              currentType = key;
              currentCharacter = null;
            } else if (category === '关系人物') {
              currentCharacter = {
                name: key,
                details: {
                  interactions: []
                }
              };
            } else if (currentCharacter) {
              switch (category) {
                case '好感度':
                  currentCharacter.favor = parseInt(key);
                  break;
                case '身份':
                  currentCharacter.title = key;
                  break;
                case '状态':
                  currentCharacter.status = key;
                  break;
                case '基本信息':
                  if (!currentCharacter.details[category]) {
                    currentCharacter.details[category] = {};
                  }
                  currentCharacter.details[category][key] = value;
                  break;
                case '性格特征':
                  currentCharacter.details[category] = key;
                  break;
                case '外貌':
                  currentCharacter.details[category] = key;
                  break;
                case '穿着':
                  currentCharacter.details[category] = key;
                  break;
                case '互动记录':
                  const [date, content] = key.split(':');
                  currentCharacter.details.interactions.push({
                    date,
                    content
                  });
                  break;
              }
            }
          });

          // 添加最后一个角色
          if (currentCharacter) {
            if (!relationships[currentType]) {
              relationships[currentType] = [];
            }
            relationships[currentType].push(currentCharacter);
          }

          return relationships;
        } catch (e) {
          console.error('解析交际信息失败:', e);
          return null;
        }
      },

      extractTimelineInfo(text) {
        const match = text.match(/<timelineinfo>([\s\S]*?)<\/timelineinfo>/);
        if (!match) return null;

        try {
          const events = [];
          let currentEvent = {};

          const lines = match[1].trim().split('\n');
          lines.forEach(line => {
            const [category, key, value] = line.split('|').map(s => s.trim());

            // 修改这里的判断逻辑
            if (category.startsWith('事件')) {
              // 当遇到新事件的日期时，保存前一个事件并开始新事件
              if (key === '日期') {
                if (Object.keys(currentEvent).length > 0) {
                  events.push({ ...currentEvent });
                }
                currentEvent = {};
              }

              switch (key) {
                case '日期':
                  currentEvent.date = value;
                  break;
                case '标题':
                  currentEvent.title = value;
                  break;
                case '描述':
                  currentEvent.description = value;
                  break;
                case '影响':
                  currentEvent.impact = value;
                  break;
                case '标签':
                  currentEvent.tags = value.split(',').map(tag => tag.trim());
                  break;
              }
            }
          });

          // 确保添加最后一个事件
          if (Object.keys(currentEvent).length > 0) {
            events.push(currentEvent);
          }

          return events;
        } catch (e) {
          console.error('解析大事记失败:', e);
          return null;
        }
      },

      extractSectInfo(text) {
        const match = text.match(/<sectinfo>([\s\S]*?)<\/sectinfo>/);
        if (!match) return null;

        try {
          const info = {
            basic: {},
            ranks: {},
            status: {},
            facilities: [],
            tasks: [],
            resources: {},
            rules: []
          };

          const lines = match[1].trim().split('\n');
          lines.forEach(line => {
            const [category, ...values] = line.split('|').map(s => s.trim());

            switch (category) {
              case '宗门':
                if (values[0] === '地位') {
                  info.ranks[values[1]] = values[2];
                } else {
                  info.basic[values[0]] = values[1];
                }
                break;
              case '主角身份':
                info.status[values[0]] = values[1];
                break;
              case '宗门设施':
                info.facilities.push({
                  name: values[0],
                  description: values[1]
                });
                break;
              case '宗门任务':
                info.tasks.push({
                  name: values[0],
                  difficulty: values[1],
                  reward: values[2]
                });
                break;
              case '宗门资源':
                info.resources[values[0]] = values[1];
                break;
              case '宗门规则':
                info.rules.push({
                  rule: values[0],
                  consequence: values[1]
                });
                break;
            }
          });

          return info;
        } catch (e) {
          console.error('解析宗门信息失败:', e);
          return null;
        }
      }
    };

    // ==================== UI更新模块 ====================
    const UIUpdater = {
      updateMainContent(content) {
        if (!content) return;

        const contentPanel = document.querySelector('#content');
        if (!contentPanel) return;

        contentPanel.innerHTML = `
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">当前时间</span>
                <span class="status-value">${content.time}</span>
            </div>
            <div class="status-item">
                <span class="status-label">当前位置</span>
                <span class="status-value">${content.location}</span>
            </div>
            <div class="status-item">
                <span class="status-label">财产</span>
                <span class="status-value">${content.wealth}</span>
            </div>
        </div>
        <h2>${content.title}</h2>
        <div class="story-content">${content.content}</div>
    `;
      },

      updateCharacterInfo(info) {
        if (!info) return;

        const characterPanel = document.querySelector('#character');
        if (!characterPanel) return;

        characterPanel.innerHTML = `
            <h2>主角信息</h2>
            <div class="info-section">
                <div class="basic-info">
                    <p><strong>年龄：</strong>${info.basic.年龄}</p>
                    <p><strong>寿元：</strong>${info.basic.寿元}</p>
                    <p><strong>性别：</strong>${info.basic.性别}</p>
                    <p><strong>种族：</strong>${info.basic.种族}</p>
                    <p><strong>声望：</strong>${info.basic.声望}</p>
                    <p><strong>资质：</strong>${info.basic.资质}</p>
                </div>
                
                <div class="cultivation-system">
                    <h3>修炼体系</h3>
                    <p><strong>主修：</strong>${info.cultivation.主修}</p>
                    <p><strong>分支：</strong>${info.cultivation.分支}</p>
                    <p><strong>特性：</strong>${info.cultivation.特性}</p>
                </div>

                <div class="attributes-section">
                    <div class="radar-chart">
                        <canvas id="attributesChart" width="300" height="300"></canvas>
                    </div>
                    <div class="attributes-list">
                        ${Object.entries(info.attributes).map(([name, value]) => `
                            <div class="attribute-item">
                                <div class="attribute-name">${name}</div>
                                <div class="attribute-value">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="realm-info">
                    <h3>境界</h3>
                    <p><strong>${info.realm.名称}</strong></p>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${info.realm.进度}%"></div>
                    </div>
                    <span class="progress-text">${info.realm.进度}%</span>
                </div>

                <div class="skills-section">
                    <h3>功法</h3>
                    ${info.skills.map((skill, index) => `
                        <div class="skill-item">
                            <div class="skill-header">
                                <span>${skill.名称} (${skill.等级})</span>
                                <button class="detail-btn" onclick="EventHandler.toggleDetails('skill${index}')">详情</button>
                            </div>
                            <div class="skill-details" id="skill${index}">
                                <p>${skill.描述}</p>
                                <p>当前效果：${skill.效果}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="artifacts-section">
                    <h3>法宝</h3>
                    ${info.artifacts.map((artifact, index) => `
                        <div class="artifact-item">
                            <div class="artifact-header">
                                <span>${artifact.名称} (${artifact.品级})</span>
                                <button class="detail-btn" onclick="EventHandler.toggleDetails('artifact${index}')">详情</button>
                            </div>
                            <div class="skill-details" id="artifact${index}">
                                <p>${artifact.描述}</p>
                                <p>当前效果：${artifact.效果}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="backpack-section">
                    <h3>背包</h3>
                    <ul>
                        ${info.backpack.map((item, index) => `
                            <li>
                                <button class="detail-btn" onclick="EventHandler.toggleDetails('item${index}')">${item.name}</button>
                                <div class="item-details" id="item${index}" style="display: none;">
                                    <p><strong>描述：</strong>${item.description}</p>
                                    <p><strong>数量：</strong>${item.quantity}</p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;

        // 绘制雷达图
        GraphicsRenderer.drawRadarChart(info.attributes, info);
      },

      updateSocialInfo(relationships) {
        if (!relationships) return;

        const socialPanel = document.querySelector('#social');
        if (!socialPanel) return;

        socialPanel.innerHTML = `
            <div class="social-controls">
                <div class="search-box">
                    <input type="text" id="character-search" placeholder="搜索人物...">
                </div>
                <div class="filter-controls">
                    <select id="relation-filter">
                        <option value="all">所有关系</option>
                        ${Object.keys(relationships).map(type =>
          `<option value="${type}">${type}</option>`
        ).join('')}
                    </select>
                </div>
            </div>

            ${Object.entries(relationships).map(([type, characters]) => `
                <div class="relationship-category" data-type="${type}">
                    <h3>${type}</h3>
                    <div class="relationship-list">
    ${characters.map(char => `
        <div class="relationship-item" data-favor="${char.favor}">
            <div class="character-basic">
                <div class="character-name">
                    ${char.name} (好感度：${char.favor})
                </div>
                <div class="character-info">${char.title}</div>
                <div class="character-status">当前状态：${char.status}</div>
            </div>
            <div class="character-details">
                <div class="detail-section">
                    <h4>基本信息</h4>
                    ${Object.entries(char.details['基本信息'] || {}).map(([key, value]) =>
          `<p>${key}：${value}</p>`
        ).join('')}
                </div>
                
                <div class="detail-section">
                    <h4>性格特征</h4>
                    <p>${char.details['性格特征']}</p>
                </div>
                
                <div class="detail-section">
                    <h4>互动记录</h4>
                    ${char.details.interactions?.map(interaction => `
                        <div class="interaction-item">
                            <span class="interaction-date">${interaction.date}</span>：
                            <span class="interaction-content">${interaction.content}</span>
                        </div>
                    `).join('') || ''}
                </div>

                <div class="detail-section">
                    <h4>外貌</h4>
                    <p>${char.details['外貌']}</p>
                </div>
                <div class="detail-section">
                    <h4>穿着</h4>
                    <p>${char.details['穿着']}</p>
                </div>
            </div>
            <button class="detail-toggle">展开详情</button>
        </div>
    `).join('')}
                    </div>
                </div>
            `).join('')}
        `;

        // 绑定事件监听器
        EventHandler.bindSocialEventListeners();
      },

      updateTimelineInfo(events) {
        if (!events) return;

        const timelinePanel = document.querySelector('#events');
        if (!timelinePanel) return;

        timelinePanel.innerHTML = `
            <h2>大事记</h2>
            <div class="timeline-controls">
                <div class="search-box">
                    <input type="text" id="event-search" placeholder="搜索事件...">
                </div>
                <div class="filter-controls">
                    <select id="event-filter">
                        <option value="all">所有事件</option>
                        ${[...new Set(events.flatMap(event => event.tags))].map(tag =>
          `<option value="${tag}">${tag}</option>`
        ).join('')}
                    </select>
                </div>
            </div>
            
            <div class="timeline-container">
                ${events.map(event => `
                    <div class="timeline-event" data-tags="${event.tags.join(',')}">
                        <div class="timeline-date">
                            <span class="date-text">${event.date}</span>
                            <div class="timeline-connector"></div>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">${event.title}</div>
                            <div class="timeline-description">${event.description}</div>
                            <div class="timeline-impact">
                                <strong>影响：</strong>${event.impact}
                            </div>
                            <div class="timeline-tags">
                                ${event.tags.map(tag =>
          `<span class="timeline-tag">${tag}</span>`
        ).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // 绑定事件监听器
        EventHandler.bindTimelineEventListeners();
      },

      updateSectInfo(sectInfo) {
        if (!sectInfo) return;

        const sectPanel = document.querySelector('#sect');
        if (!sectPanel) return;

        sectPanel.innerHTML = `
            <h2>宗门信息</h2>
            <div class="sect-content">
                <div class="sect-basic">
                    <h3>${sectInfo.basic.名称}</h3>
                    <div class="sect-ranks">
                        ${Object.entries(sectInfo.ranks).map(([world, rank]) => `
                            <p><strong>${world}：</strong>${rank}</p>
                        `).join('')}
                    </div>
                    <p><strong>最强者：</strong>${sectInfo.basic.最强者}</p>
                    <p><strong>山门：</strong>${sectInfo.basic.山门}</p>
                    <p><strong>历史：</strong>${sectInfo.basic.历史}</p>
                    <p><strong>特色：</strong>${sectInfo.basic.特色}</p>
                </div>

                <div class="sect-status">
                    <h3>主角身份</h3>
                    <p><strong>当前职位：</strong>${sectInfo.status.当前职位}</p>
                    <p><strong>贡献度：</strong>${sectInfo.status.贡献度}</p>
                    <p><strong>晋升条件：</strong>${sectInfo.status.晋升条件}</p>
                </div>

                <div class="sect-facilities">
                    <h3>宗门设施</h3>
                    <div class="facilities-grid">
                        ${sectInfo.facilities.map(facility => `
                            <div class="facility-item">
                                <h4>${facility.name}</h4>
                                <p>${facility.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="sect-tasks">
                    <h3>宗门任务</h3>
                    ${sectInfo.tasks.map(task => `
                        <div class="task-item">
                            <h4>${task.name}</h4>
                            <p><strong>难度：</strong>${task.difficulty}</p>
                            <p><strong>奖励：</strong>${task.reward}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="sect-resources">
                    <h3>宗门资源</h3>
                    ${Object.entries(sectInfo.resources).map(([resource, value]) => `
                        <p><strong>${resource}：</strong>${value}</p>
                    `).join('')}
                </div>

                <div class="sect-rules">
                    <h3>宗门规则</h3>
                    ${sectInfo.rules.map(rule => `
                        <div class="rule-item">
                            <p><strong>${rule.rule}</strong></p>
                            <p class="rule-consequence">${rule.consequence}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
      }
    };

    // ==================== 事件处理模块 ====================
    const EventHandler = {
      bindSocialEventListeners() {
        // 搜索功能
        document.getElementById('character-search')?.addEventListener('input', this.filterCharacters);
        // 筛选功能
        document.getElementById('relation-filter')?.addEventListener('change', this.filterCharacters);
        // 详情展开/收起
        document.querySelectorAll('.detail-toggle').forEach(button => {
          button.addEventListener('click', function () {
            const details = this.previousElementSibling;
            const isExpanded = details.style.display === 'block';
            details.style.display = isExpanded ? 'none' : 'block';
            this.textContent = isExpanded ? '展开详情' : '收起详情';
          });
        });
      },

      bindTimelineEventListeners() {
        // 搜索功能
        document.getElementById('event-search')?.addEventListener('input', this.filterEvents);
        // 标签筛选
        document.getElementById('event-filter')?.addEventListener('change', this.filterEvents);
      },

      filterCharacters() {
        const searchText = document.getElementById('character-search')?.value.toLowerCase() || '';
        const selectedRelation = document.getElementById('relation-filter')?.value;

        document.querySelectorAll('.relationship-item').forEach(item => {
          const name = item.querySelector('.character-name').textContent.toLowerCase();
          const category = item.closest('.relationship-category').dataset.type;

          const matchesSearch = name.includes(searchText);
          const matchesRelation = selectedRelation === 'all' || category === selectedRelation;

          item.style.display = matchesSearch && matchesRelation ? 'block' : 'none';
        });
      },

      filterEvents() {
        const searchText = document.getElementById('event-search')?.value.toLowerCase() || '';
        const selectedTag = document.getElementById('event-filter')?.value;

        document.querySelectorAll('.timeline-event').forEach(event => {
          const title = event.querySelector('.timeline-title').textContent.toLowerCase();
          const description = event.querySelector('.timeline-description').textContent.toLowerCase();
          const tags = event.dataset.tags.split(',');

          const matchesSearch = title.includes(searchText) || description.includes(searchText);
          const matchesTag = selectedTag === 'all' || tags.includes(selectedTag);

          event.style.display = matchesSearch && matchesTag ? 'flex' : 'none';
        });
      },

      toggleDetails(id) {
        const details = document.getElementById(id);
        const button = document.querySelector(`button[data-target="${id}"]`);

        if (details) {
          const isHidden = details.style.display === 'none' || !details.style.display;
          details.style.display = isHidden ? 'block' : 'none';
          if (button) {
            button.textContent = isHidden ? '收起' : '详情';
          }
        }
      }
    };

    // ==================== 图形绘制模块 ====================
    const GraphicsRenderer = {
      drawRadarChart(attributes, characterInfo) {  // 添加characterInfo参数
        const canvas = document.getElementById('attributesChart');
        if (!canvas || !characterInfo || !characterInfo.realm) return;

        // 获取当前境界和对应等级
        const realm = characterInfo.realm.名称;
        const cultivationSystems = {
          // 等级1的所有境界和小境界
          level1: {
            '道门': { '养魂': 1, '养魂初期': 1, '养魂小成': 1, '养魂大成': 1, '养魂圆满': 1 },
            '神道': { '游魂': 1, '游魂初期': 1, '游魂小成': 1, '游魂大成': 1, '游魂圆满': 1 },
            '武道': { '锻体': 1, '锻体初期': 1, '锻体中期': 1, '锻体后期': 1, '锻体圆满': 1 },
            '佛门': { '眼识': 1, '眼识初开': 1, '眼识渐明': 1, '眼识大成': 1, '眼识圆满': 1 },
            '墨家': { '机巧': 1, '机巧入门': 1, '机巧小成': 1, '机巧大成': 1, '机巧圆满': 1 },
            '儒家': { '启蒙': 1, '启蒙初悟': 1, '启蒙渐明': 1, '启蒙大成': 1, '启蒙圆满': 1 },
            '法家': { '执法': 1, '执法初期': 1, '执法小成': 1, '执法大成': 1, '执法圆满': 1 }
          },

          // 等级2的所有境界和小境界
          level2: {
            '道门': { '壮魂': 2, '壮魂初期': 2, '壮魂小成': 2, '壮魂大成': 2, '壮魂圆满': 2 },
            '神道': { '游神': 2, '游神初期': 2, '游神小成': 2, '游神大成': 2, '游神圆满': 2 },
            '武道': { '养气': 2, '养气初期': 2, '养气小成': 2, '养气大成': 2, '养气圆满': 2 },
            '佛门': { '耳识': 2, '耳识初开': 2, '耳识渐明': 2, '耳识大成': 2, '耳识圆满': 2 },
            '墨家': { '物匠': 2, '物匠初期': 2, '物匠小成': 2, '物匠大成': 2, '物匠圆满': 2 },
            '儒家': { '明理': 2, '明理初期': 2, '明理小成': 2, '明理大成': 2, '明理圆满': 2 },
            '法家': { '律法': 2, '律法初期': 2, '律法小成': 2, '律法大成': 2, '律法圆满': 2 }
          },

          // 等级3的所有境界和小境界
          level3: {
            '道门': { '出窍': 3, '出窍初期': 3, '出窍小成': 3, '出窍大成': 3, '出窍圆满': 3 },
            '神道': { '灵神': 3, '灵神初期': 3, '灵神小成': 3, '灵神大成': 3, '灵神圆满': 3 },
            '武道': { '先天': 3, '先天初期': 3, '先天小成': 3, '先天大成': 3, '先天圆满': 3 },
            '佛门': { '口识': 3, '口识初开': 3, '口识渐明': 3, '口识大成': 3, '口识圆满': 3 },
            '墨家': { '机心': 3, '机心初期': 3, '机心小成': 3, '机心大成': 3, '机心圆满': 3 },
            '儒家': { '格物': 3, '格物初期': 3, '格物小成': 3, '格物大成': 3, '格物圆满': 3 },
            '法家': { '执政': 3, '执政初期': 3, '执政小成': 3, '执政大成': 3, '执政圆满': 3 }
          },
          level4: {
            '道门': { '引气': 4, '引气初期': 4, '引气小成': 4, '引气大成': 4, '引气圆满': 4 },
            '神道': { '判官': 4, '初入判官': 4, '判官小成': 4, '判官大成': 4, '判官圆满': 4 },
            '武道': { '神意': 4, '神意初期': 4, '神意小成': 4, '神意大成': 4, '神意圆满': 4 },
            '佛门': { '鼻识': 4, '鼻识初开': 4, '鼻识渐明': 4, '鼻识大成': 4, '鼻识圆满': 4 },
            '墨家': { '器灵': 4, '器灵初期': 4, '器灵小成': 4, '器灵大成': 4, '器灵圆满': 4 },
            '儒家': { '致知': 4, '致知初期': 4, '致知小成': 4, '致知大成': 4, '致知圆满': 4 },
            '法家': { '秩序': 4, '秩序初期': 4, '秩序小成': 4, '秩序大成': 4, '秩序圆满': 4 }
          },

          // 等级5的所有境界和小境界
          level5: {
            '道门': { '神魂': 5, '神魂初境': 5, '神魂中境': 5, '神魂上境': 5, '神魂圆满': 5 },
            '神道': { '地祗': 5, '初入地祗': 5, '地祗小成': 5, '地祗大成': 5, '地祗圆满': 5 },
            '武道': { '炼窍': 5, '炼窍初期': 5, '炼窍小成': 5, '炼窍大成': 5, '炼窍圆满': 5 },
            '佛门': { '身识': 5, '身识初开': 5, '身识渐明': 5, '身识大成': 5, '身识圆满': 5 },
            '墨家': { '机师': 5, '机师初期': 5, '机师小成': 5, '机师大成': 5, '机师圆满': 5 },
            '儒家': { '诚明': 5, '诚明初期': 5, '诚明小成': 5, '诚明大成': 5, '诚明圆满': 5 },
            '法家': { '法理': 5, '法理初期': 5, '法理小成': 5, '法理大成': 5, '法理圆满': 5 },
            '外道': { '神通': 5, '神通初期': 5, '神通小成': 5, '神通大成': 5, '神通圆满': 5 }
          },

          // 等级6的所有境界和小境界
          level6: {
            '道门': { '下品金丹初期': 6, '下品金丹小成': 6, '下品金丹大成': 6, '下品金丹圆满': 6 },
            '道门': { '中品金丹初期': 6, '中品金丹小成': 6, '中品金丹大成': 6, '中品金丹圆满': 6 },
            '道门': { '上品金丹初期': 6, '上品金丹小成': 6, '上品金丹大成': 6, '上品金丹圆满': 6 },
            '神道': { '灵官': 6, '初入灵官': 6, '灵官小成': 6, '灵官大成': 6, '灵官圆满': 6 },
            '武道': { '武相': 6, '武相初期': 6, '武相小成': 6, '武相大成': 6, '武相圆满': 6 },
            '佛门': { '意识': 6, '意识初开': 6, '意识渐明': 6, '意识大成': 6, '意识圆满': 6 },
            '墨家': { '机皇': 6, '机皇初期': 6, '机皇小成': 6, '机皇大成': 6, '机皇圆满': 6 },
            '儒家': { '正心': 6, '正心初期': 6, '正心小成': 6, '正心大成': 6, '正心圆满': 6 },
            '法家': { '法令': 6, '法令初期': 6, '法令小成': 6, '法令大成': 6, '法令圆满': 6 },
            '外道': { '金丹': 6, '金丹初期': 6, '金丹小成': 6, '金丹大成': 6, '大圆满金丹': 6 },
          },

          // 等级7的所有境界和小境界
          level7: {
            '道门': { '阴神': 7, '感应真灵': 7, '壮大真灵': 7, '凝练真灵': 7, '真灵圆满': 7 },
            '神道': { '神尊': 7, '初入神尊': 7, '神尊小成': 7, '神尊大成': 7, '神尊圆满': 7 },
            '武道': { '人仙': 7, '人仙初期': 7, '人仙小成': 7, '人仙大成': 7, '人仙圆满': 7 },
            '佛门': { '罗汉': 7, '初入罗汉': 7, '小罗汉': 7, '大罗汉': 7, '罗汉圆满': 7 },
            '墨家': { '机圣': 7, '机圣初期': 7, '机圣小成': 7, '机圣大成': 7, '机圣圆满': 7 },
            '儒家': { '修齐': 7, '修齐初期': 7, '修齐小成': 7, '修齐大成': 7, '修齐圆满': 7 },
            '法家': { '法圣': 7, '法圣初期': 7, '法圣小成': 7, '法圣大成': 7, '法圣圆满': 7 },
            '外道': { '法相真人': 7, '法相初期': 7, '法相小成': 7, '法相大成': 7, '法相圆满': 7 }
          },
          level8: {
            '道门': { '元神': 8, '元神期': 8, '阳神一劫': 8, '阳神二劫': 8, '阳神三劫': 8 },
            '神道': { '神灵': 8, '初入神灵': 8, '神灵小成': 8, '神灵大成': 8, '神灵圆满': 8 },
            '武道': { '地仙': 8, '地仙初期': 8, '地仙小成': 8, '地仙大成': 8, '地仙圆满': 8 },
            '佛门': { '菩萨': 8, '初入菩萨': 8, '菩萨小成': 8, '菩萨大成': 8, '菩萨圆满': 8 },
            '墨家': { '巨子': 8, '巨子初期': 8, '巨子小成': 8, '巨子大成': 8, '巨子圆满': 8 },
            '儒家': { '圣贤': 8, '圣贤初期': 8, '圣贤小成': 8, '圣贤大成': 8, '圣贤圆满': 8 },
            '法家': { '法皇': 8, '法皇初期': 8, '法皇小成': 8, '法皇大成': 8, '法皇圆满': 8 },
            '外道': { '元神真人': 8, '元神初期': 8, '元神小成': 8, '元神大成': 8, '元神圆满': 8 }
          },

          // 等级9的所有境界和小境界
          level9: {
            '道门': { '天人': 9, '天仙大能': 9, '一劫天君': 9, '二劫天君': 9, '三劫天君': 9, '四劫天君': 9 },
            '神道': { '神君': 9, '初入神君': 9, '神君小成': 9, '神君大成': 9, '神君圆满': 9 },
            '武道': { '天仙': 9, '天仙初期': 9, '天仙小成': 9, '天仙大成': 9, '天仙圆满': 9 },
            '佛门': { '佛陀': 9, '初入佛陀': 9, '佛陀小成': 9, '佛陀大成': 9, '佛陀圆满': 9 }
          },

          // 等级10的所有境界和小境界
          level10: {
            '道门': { '半步金仙': 10, '万法归道': 10, '圆满道基': 10, '得道真意': 10, '外道演法': 10 },
            '神道': { '准圣': 10, '准圣初期': 10, '准圣小成': 10, '准圣大成': 10, '准圣圆满': 10 },
            '武道': { '武圣': 10, '武圣初期': 10, '武圣小成': 10, '武圣大成': 10, '武圣圆满': 10 },
            '佛门': { '未来佛祖': 10, '初入未来': 10, '未来小成': 10, '未来大成': 10, '未来圆满': 10 }
          },

          // 等级11的所有境界和小境界
          level11: {
            '道门': { '合道': 11, '后天道祖': 11, '先天道祖': 11, '道祖大成': 11, '合道圆满': 11 },
            '神道': { '神圣': 11, '神圣初期': 11, '神圣小成': 11, '神圣大成': 11, '神圣圆满': 11 },
            '武道': { '武道至尊': 11, '至尊初期': 11, '至尊小成': 11, '至尊大成': 11, '至尊圆满': 11 },
            '佛门': { '佛祖': 11, '初入佛祖': 11, '佛祖小成': 11, '佛祖大成': 11, '佛祖圆满': 11 }
          },

          // 等级12的所有境界和小境界
          level12: {
            '道门': { '造化': 12, '初入造化': 12, '造化小成': 12, '造化大成': 12, '造化圆满': 12 },
            '神道': { '天道': 12, '天道初期': 12, '天道小成': 12, '天道大成': 12, '天道圆满': 12 },
            '武道': { '武神': 12, '武神初期': 12, '武神小成': 12, '武神大成': 12, '武神圆满': 12 },
            '佛门': { '佛主': 12, '初入佛主': 12, '佛主小成': 12, '佛主大成': 12, '佛主圆满': 12 }
          },

          // 等级13的所有境界和小境界
          level13: {
            '道门': { '永恒': 13, '初入永恒': 13, '永恒小成': 13, '永恒大成': 13, '永恒圆满': 13 }
          }
        };
        let level = 1;
        for (let i = 1; i <= 13; i++) {
          const levelData = cultivationSystems[`level${i}`];
          for (const schoolData of Object.values(levelData)) {
            if (Object.keys(schoolData).includes(realm)) {
              level = i;
              break;
            }
          }
          if (level !== 1) break;
        }
        const maxValue = level === 1 ? 20 : level === 2 ? 60 : 60 * Math.pow(3, level - 2);

        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 120;

        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 获取属性数据并归一化
        const attributeNames = Object.keys(attributes);
        const attributeValues = Object.values(attributes).map(value =>
          (value / maxValue) * 100  // 将值归一化到0-100范围
        );
        const sides = attributeNames.length;

        // 绘制背景网格
        for (let gridLevel = 1; gridLevel <= 5; gridLevel++) {
          ctx.beginPath();
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';

          for (let i = 0; i < sides; i++) {
            const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
            const r = (radius * gridLevel) / 5;
            const x = centerX + r * Math.cos(angle);
            const y = centerY + r * Math.sin(angle);

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }

          ctx.closePath();
          ctx.stroke();

          // 添加刻度值标注
          const scaleValue = Math.round((maxValue * gridLevel) / 5);
          ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
          ctx.font = '12px var(--global-font)';
          ctx.fillText(scaleValue.toString(), centerX + 5, centerY - (radius * gridLevel) / 5);
        }

        // 绘制属性轴线和名称
        for (let i = 0; i < sides; i++) {
          const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;

          // 绘制轴线
          ctx.beginPath();
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(
            centerX + radius * Math.cos(angle),
            centerY + radius * Math.sin(angle)
          );
          ctx.stroke();

          // 绘制属性名称和当前值
          ctx.fillStyle = '#333';
          ctx.font = '14px var(--global-font)';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          const textRadius = radius + 20;
          const textX = centerX + textRadius * Math.cos(angle);
          const textY = centerY + textRadius * Math.sin(angle);

          const originalValue = Object.values(attributes)[i];
          ctx.fillText(`${attributeNames[i]}(${originalValue})`, textX, textY);
        }

        // 绘制数值区域
        ctx.beginPath();
        ctx.fillStyle = 'rgba(76, 175, 80, 0.2)';
        ctx.strokeStyle = 'rgba(76, 175, 80, 0.8)';
        ctx.lineWidth = 2;

        for (let i = 0; i < sides; i++) {
          const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
          const value = attributeValues[i];
          const r = (radius * value) / 100;
          const x = centerX + r * Math.cos(angle);
          const y = centerY + r * Math.sin(angle);

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }

        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // 绘制数值点
        attributeValues.forEach((value, i) => {
          const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
          const r = (radius * value) / 100;
          const x = centerX + r * Math.cos(angle);
          const y = centerY + r * Math.sin(angle);

          ctx.beginPath();
          ctx.fillStyle = '#4CAF50';
          ctx.arc(x, y, 4, 0, 2 * Math.PI);
          ctx.fill();
        });

        // 显示当前境界和等级信息
        ctx.fillStyle = '#333';
        ctx.font = '14px var(--global-font)';
        ctx.textAlign = 'left';
        ctx.fillText(`当前境界: ${realm}`, 10, 20);
        ctx.fillText(`属性上限: ${maxValue}`, 10, 40);
      }
    };

    // ==================== 初始化代码 ====================
    document.addEventListener('DOMContentLoaded', function () {
      initializeUI();
      bindEventListeners();

      // 执行自动检测和填补
      autoCheckAndFill();

      if (typeof gameText !== 'undefined') {
        processGameText(gameText);
      }
    });

    // 主处理函数
    function processGameText(text) {
      const mainContent = DataExtractor.extractMainContent(text);
      const characterInfo = DataExtractor.extractCharacterInfo(text);
      const socialInfo = DataExtractor.extractSocialInfo(text);
      const timelineInfo = DataExtractor.extractTimelineInfo(text);
      const sectInfo = DataExtractor.extractSectInfo(text);

      UIUpdater.updateMainContent(mainContent);
      if (characterInfo && characterInfo.attributes) {
        GraphicsRenderer.drawRadarChart(characterInfo.attributes, characterInfo);
      }
      UIUpdater.updateCharacterInfo(characterInfo);
      UIUpdater.updateSocialInfo(socialInfo);
      UIUpdater.updateTimelineInfo(timelineInfo);
      UIUpdater.updateSectInfo(sectInfo);
    }

    // 初始化UI
    function initializeUI() {
      // 绑定导航按钮事件
      document.querySelectorAll('.nav-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));

          button.classList.add('active');
          const panelId = button.getAttribute('data-panel');
          document.getElementById(panelId).classList.add('active');
        });
      });

      // 初始化设置面板
      initializeSettings();
    }

    // 绑定全局事件监听器
    function bindEventListeners() {
      // 窗口大小改变时重绘雷达图
      window.addEventListener('resize', () => {
        const characterInfo = DataExtractor.extractCharacterInfo(gameText);
        if (characterInfo) {
          GraphicsRenderer.drawRadarChart(characterInfo.attributes, characterInfo);
        }
      });
    }

    // 初始化设置
    function initializeSettings() {
      // 从 localStorage 加载保存的设置
      const savedSettings = loadSettings();

      // 字体选择
      const fontSelect = document.getElementById('fontSelect');
      if (fontSelect) {
        // 设置保存的字体
        if (savedSettings.font) {
          fontSelect.value = savedSettings.font;
          document.documentElement.style.setProperty('--global-font', savedSettings.font);
        }

        fontSelect.addEventListener('change', function () {
          document.documentElement.style.setProperty('--global-font', this.value);
          saveSettings('font', this.value);
        });
      }

      // 字体大小
      const fontSizeSlider = document.getElementById('fontSize');
      const fontSizeValue = document.getElementById('fontSizeValue');
      if (fontSizeSlider && fontSizeValue) {
        // 设置保存的字体大小
        if (savedSettings.fontSize) {
          fontSizeSlider.value = savedSettings.fontSize;
          fontSizeValue.textContent = savedSettings.fontSize + 'px';
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.fontSize = savedSettings.fontSize + 'px';
          });
        }

        fontSizeSlider.addEventListener('input', function () {
          const size = this.value;
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.fontSize = size + 'px';
          });
          fontSizeValue.textContent = size + 'px';
          saveSettings('fontSize', size);
        });
      }

      // 窗口颜色
      const windowColorInput = document.getElementById('windowColor');
      const windowColorPreview = document.getElementById('windowColorPreview');
      if (windowColorInput && windowColorPreview) {
        // 设置保存的窗口颜色
        if (savedSettings.windowColor) {
          windowColorInput.value = savedSettings.windowColor;
          windowColorPreview.style.backgroundColor = savedSettings.windowColor;
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.backgroundColor = savedSettings.windowColor;
          });
        }

        windowColorInput.addEventListener('input', function () {
          const color = this.value;
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.backgroundColor = color;
          });
          windowColorPreview.style.backgroundColor = color;
          saveSettings('windowColor', color);
        });
      }

      // 窗口透明度
      const opacitySlider = document.getElementById('windowOpacity');
      const opacityValue = document.getElementById('opacityValue');
      if (opacitySlider && opacityValue) {
        // 设置保存的透明度
        if (savedSettings.opacity) {
          opacitySlider.value = savedSettings.opacity;
          opacityValue.textContent = savedSettings.opacity + '%';
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.opacity = savedSettings.opacity / 100;
          });
        }

        opacitySlider.addEventListener('input', function () {
          const opacity = this.value;
          document.querySelectorAll('.panel').forEach(panel => {
            panel.style.opacity = opacity / 100;
          });
          opacityValue.textContent = opacity + '%';
          saveSettings('opacity', opacity);
        });
      }
    }

    // 添加保存设置的函数
    function saveSettings(key, value) {
      try {
        let settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        settings[key] = value;
        localStorage.setItem('userSettings', JSON.stringify(settings));
      } catch (e) {
        console.error('保存设置失败:', e);
      }
    }

    // 添加加载设置的函数
    function loadSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return settings;
      } catch (e) {
        console.error('加载设置失败:', e);
        return {};
      }
    }

    // 添加重置设置的函数
    function resetSettings() {
      const defaultSettings = {
        font: 'chengrongguangke',
        fontSize: '16',
        windowColor: '#ffffff',
        opacity: '81'
      };

      localStorage.setItem('userSettings', JSON.stringify(defaultSettings));
      return defaultSettings;
    }
    function resetAndApplySettings() {
      if (confirm('确定要重置所有设置吗？')) {
        const defaultSettings = resetSettings();

        // 重新加载页面以应用默认设置
        location.reload();
      }
    }

    let archiveSaved = false;

    async function saveArchive() {
      try {
        if (archiveSaved) return;
        archiveSaved = true;

        // 获取最后一条消息
        let chatContent = await triggerSlashWithResult(`/messages {{lastMessageId}}`);

        // 只保留<gametext>标签内的内容
        let gametextMatch = chatContent.match(/<gametext>[\s\S]*?<\/gametext>/);
        if (!gametextMatch) {
          throw new Error('未找到gametext内容');
        }
        chatContent = gametextMatch[0];

        // 移除<maincontent>标签及其内容
        chatContent = chatContent.replace(/<maincontent>[\s\S]*?<\/maincontent>\n?/, '');

        // 移除gametext标签之外的内容
        chatContent = chatContent.replace(/^[\s\S]*?<gametext>/, '<gametext>');
        chatContent = chatContent.replace(/<\/gametext>[\s\S]*$/, '</gametext>');

        // 处理内容中的特殊字符，但保留换行
        const processedContent = chatContent
          .replace(/\|/g, '\\|')
          .replace(/"/g, '\\"')
          .replace(/'/g, "\\'");

        // 调试信息
        console.log('存档内容:', processedContent);

        try {
          // 保存到两个uid
          const command1 = `/setentryfield file=1xianxia uid=16 field=content "${processedContent}"`;
          const command2 = `/setentryfield file=1xianxia uid=17 field=content "${processedContent}"`;

          console.log('执行命令1:', command1);
          console.log('执行命令2:', command2);

          await triggerSlashWithResult(command1);
          await triggerSlashWithResult(command2);

          alert('存档已保存！');
        } catch (error) {
          console.error('保存存档失败:', error);
          alert('保存存档失败，请检查世界书和uid是否正确！');
          archiveSaved = false;
        }
      } catch (error) {
        console.error('获取聊天内容失败:', error);
        alert('获取聊天内容失败！');
        archiveSaved = false;
      }
    }

    // 添加自动检测和填补功能
    async function autoCheckAndFill() {
      try {
        // 1. 获取最后一条消息内容
        const currentContent = await triggerSlashWithResult("/messages {{lastMessageId}}");

        // 2. 提取gametext内容并保存到uid18
        const gametextMatch = currentContent.match(/<gametext>[\s\S]*?<\/gametext>/);
        if (!gametextMatch) return;

        const processedContent = gametextMatch[0]
          .replace(/\|/g, '\\|')
          .replace(/"/g, '\\"')
          .replace(/'/g, "\\'");

        await triggerSlashWithResult(`/setentryfield file=1xianxia uid=18 field=content "${processedContent}"`);

        // 3. 从uid18和uid17获取内容
        const uid18Content = await triggerSlashWithResult(`/getentryfield file=1xianxia field=content 18`);
        const uid17Content = await triggerSlashWithResult(`/getentryfield file=1xianxia field=content 17`);

        // 4. 检查和填补标签
        const xmlTags = ['characterinfo', 'socialinfo', 'timelineinfo', 'sectinfo'];
        let updatedContent = uid18Content;
        let hasUpdates = false;

        for (const tag of xmlTags) {
          const tagRegex = new RegExp(`<${tag}>([\\s\\S]*?)<\\/${tag}>`);
          const currentTagMatch = updatedContent.match(tagRegex);
          const savedTagMatch = uid17Content.match(tagRegex);

          if (!currentTagMatch) continue;

          const currentContent = currentTagMatch[1].trim();

          if (currentContent === '' && savedTagMatch && savedTagMatch[1].trim()) {
            updatedContent = updatedContent.replace(
              tagRegex,
              `<${tag}>${savedTagMatch[1]}</${tag}>`
            );
            hasUpdates = true;
          }
        }

        // 5. 如果有更新则执行轻扫
        if (hasUpdates) {
          const swipeContent = updatedContent
            .replace(/\|/g, '\\|')
            .replace(/"/g, '\\"')
            .replace(/'/g, "\\'");
          window.triggerSlash(`/addswipe switch=true ${swipeContent}`);
        }

        // 6. 同步保存到uid16和uid17
        const finalContent = await triggerSlashWithResult('/getentryfield file=1xianxia field=content 18');
        const syncContent = finalContent
          .replace(/\|/g, '\\|')
          .replace(/"/g, '\\"')
          .replace(/'/g, "\\'");

        await triggerSlashWithResult(`/setentryfield file=1xianxia uid=16 field=content "${syncContent}"`);
        await triggerSlashWithResult(`/setentryfield file=1xianxia uid=17 field=content "${syncContent}"`);

      } catch (error) {
        console.error('执行过程中发生错误:', error);
      }
    }

    // 立即执行autoCheckAndFill函数
    (async () => {
      try {
        await autoCheckAndFill();
        console.log('自动检测和填补执行完成');
      } catch (error) {
        console.error('执行autoCheckAndFill时发生错误:', error);
      }
    })();
  </script>
</body>

</html>
```